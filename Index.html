<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>動画区間リピートプレイヤーα</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
    }
    video {
      max-width: 100%;
      height: auto;
    }
    #progressBarContainer {
      position: relative;
      width: 100%;
      max-width: 640px;
      height: 20px;
      background: #ddd;
      margin-top: 10px;
      cursor: pointer;
      user-select: none;
      border-radius: 5px;
    }
    .marker {
      position: absolute;
      top: 0;
      width: 4px;
      height: 20px;
      border-radius: 2px;
    }
    #startMarker { background: green; }
    #endMarker { background: blue; }
    #currentMarker { background: red; }
    #timeDisplay {
      margin-top: 6px;
      font-family: monospace;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 5px;
      margin-top: 10px;
    }
    #controls input[type=range] {
      flex: 1;
      min-width: 100px;
    }
    .time-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    .time-inputs label {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    input[type=number] {
      width: 80px;
    }
  </style>
</head>
<body>
  <h1>動画区間リピートプレイヤー</h1>
  <input type="file" id="videoInput" accept="video/*" />
  <br /><br />
  <video id="videoPlayer" controls></video>

  <div id="controls">
    再生速度:
    <input type="range" id="speedControl" min="0.1" max="3" step="0.01" value="1" />
    <input type="number" id="speedNumber" min="0.1" max="3" step="0.01" value="1.00" inputmode="decimal" />
    <span id="speedDisplay">1.00</span>x
  </div>

  <div class="time-inputs">
    <label>開始位置: 
      <input type="number" id="startInput" step="0.01" min="0" value="0" inputmode="decimal"> 秒
    </label>
    <label>終了位置: 
      <input type="number" id="endInput" step="0.01" min="0" value="0" inputmode="decimal"> 秒
    </label>
  </div>

  <div id="progressBarContainer" title="クリックまたはタップで開始/終了位置を設定"></div>
  <div id="timeDisplay">00:00 / 00:00</div>
  <p><strong>Z</strong>: 開始位置設定、<strong>X</strong>: 終了位置設定、<strong>C</strong>: リセット</p>
  <p><strong>V</strong>: 開始位置へ移動、<strong>スペース</strong>: 再生／停止</p>
  <p id="repeatRangeDisplay">リピート区間: 未設定</p>
  <button id="resetButton">リピート区間リセット</button>

  <script>
    const videoInput = document.getElementById('videoInput');
    const videoPlayer = document.getElementById('videoPlayer');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const repeatRangeDisplay = document.getElementById('repeatRangeDisplay');
    const timeDisplay = document.getElementById('timeDisplay');
    const resetButton = document.getElementById('resetButton');
    const speedControl = document.getElementById('speedControl');
    const speedNumber = document.getElementById('speedNumber');
    const speedDisplay = document.getElementById('speedDisplay');
    const startInput = document.getElementById('startInput');
    const endInput = document.getElementById('endInput');

    let repeatStart = null;
    let repeatEnd = null;

    const startMarker = createMarker('startMarker', 'green');
    const endMarker = createMarker('endMarker', 'blue');
    const currentMarker = createMarker('currentMarker', 'red');

    function createMarker(id, color) {
      const marker = document.createElement('div');
      marker.id = id;
      marker.classList.add('marker');
      marker.style.background = color;
      marker.style.display = 'none';
      progressBarContainer.appendChild(marker);
      return marker;
    }

    videoInput.addEventListener('change', () => {
      const file = videoInput.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        videoPlayer.src = url;
        videoPlayer.play();
        resetRepeat();
        videoPlayer.preservesPitch = true;
        videoPlayer.mozPreservesPitch = true;
        videoPlayer.webkitPreservesPitch = true;
      }
    });

    function setRepeatPositionFromClick(clientX) {
      if (!videoPlayer.duration) return;
      const rect = progressBarContainer.getBoundingClientRect();
      const clickRatio = (clientX - rect.left) / rect.width;
      const clickedTime = videoPlayer.duration * clickRatio;

      if (repeatStart === null || (repeatStart !== null && repeatEnd !== null)) {
        repeatStart = clickedTime;
        repeatEnd = null;
      } else {
        if (clickedTime <= repeatStart) {
          alert('終了時間は開始時間より後にしてください。');
          return;
        }
        repeatEnd = clickedTime;
      }
      updateInputsFromMarkers();
      updateMarkers();
      updateRepeatRangeDisplay();
    }

    // クリック対応
    progressBarContainer.addEventListener('click', e => {
      setRepeatPositionFromClick(e.clientX);
    });
    // タッチ対応
    progressBarContainer.addEventListener('touchstart', e => {
      const touch = e.touches[0];
      setRepeatPositionFromClick(touch.clientX);
    });

    window.addEventListener('keydown', (e) => {
      if (e.code === 'KeyZ') {
        repeatStart = videoPlayer.currentTime;
        updateInputsFromMarkers();
        updateMarkers();
        updateRepeatRangeDisplay();
      }
      if (e.code === 'KeyX') {
        if (repeatStart === null || videoPlayer.currentTime <= repeatStart) {
          alert('終了時間は開始時間より後にしてください。');
          return;
        }
        repeatEnd = videoPlayer.currentTime;
        updateInputsFromMarkers();
        updateMarkers();
        updateRepeatRangeDisplay();
      }
      if (e.code === 'KeyC') {
        resetRepeat();
      }
      if (e.code === 'KeyV') {
        if (repeatStart !== null) {
          e.preventDefault();
          videoPlayer.currentTime = repeatStart;
        }
      }
      if (e.code === 'Space') {
        e.preventDefault();
        if (videoPlayer.paused) {
          videoPlayer.play();
        } else {
          videoPlayer.pause();
        }
      }
    });

    videoPlayer.addEventListener('timeupdate', () => {
      updateCurrentMarker();
      updateTimeDisplay();
      if (repeatStart !== null && repeatEnd !== null) {
        if (videoPlayer.currentTime >= repeatEnd) {
          videoPlayer.currentTime = repeatStart;
        }
      }
    });

    resetButton.addEventListener('click', () => {
      resetRepeat();
    });

    function setPlaybackRate(rate) {
      rate = Math.min(Math.max(rate, 0.1), 3);
      videoPlayer.playbackRate = rate;
      speedControl.value = rate.toFixed(2);
      speedNumber.value = rate.toFixed(2);
      speedDisplay.textContent = rate.toFixed(2);
    }
    speedControl.addEventListener('input', () => {
      setPlaybackRate(parseFloat(speedControl.value));
    });
    speedNumber.addEventListener('input', () => {
      const val = parseFloat(speedNumber.value);
      if (!isNaN(val)) {
        setPlaybackRate(val);
      }
    });

    startInput.addEventListener('input', () => {
      const val = parseFloat(startInput.value);
      if (!isNaN(val)) {
        repeatStart = val;
        if (repeatEnd !== null && repeatEnd <= repeatStart) {
          repeatEnd = null;
          endInput.value = '';
        }
        updateMarkers();
        updateRepeatRangeDisplay();
      }
    });
    endInput.addEventListener('input', () => {
      const val = parseFloat(endInput.value);
      if (!isNaN(val)) {
        if (repeatStart !== null && val <= repeatStart) {
          alert('終了時間は開始時間より後にしてください。');
          endInput.value = repeatEnd !== null ? repeatEnd.toFixed(2) : '';
          return;
        }
        repeatEnd = val;
        updateMarkers();
        updateRepeatRangeDisplay();
      }
    });

    function resetRepeat() {
      repeatStart = null;
      repeatEnd = null;
      repeatRangeDisplay.textContent = 'リピート区間: 未設定';
      startInput.value = '';
      endInput.value = '';
      startMarker.style.display = 'none';
      endMarker.style.display = 'none';
    }

    function updateMarkers() {
      if (repeatStart !== null && videoPlayer.duration) {
        startMarker.style.left = (repeatStart / videoPlayer.duration * 100) + '%';
        startMarker.style.display = 'block';
      } else {
        startMarker.style.display = 'none';
      }
      if (repeatEnd !== null && videoPlayer.duration) {
        endMarker.style.left = (repeatEnd / videoPlayer.duration * 100) + '%';
        endMarker.style.display = 'block';
      } else {
        endMarker.style.display = 'none';
      }
    }

    function updateCurrentMarker() {
      if (!videoPlayer.duration) return;
      currentMarker.style.left = (videoPlayer.currentTime / videoPlayer.duration * 100) + '%';
      currentMarker.style.display = 'block';
    }

    function updateInputsFromMarkers() {
      if (repeatStart !== null) {
        startInput.value = repeatStart.toFixed(2);
      }
      if (repeatEnd !== null) {
        endInput.value = repeatEnd.toFixed(2);
      }
    }

    function updateRepeatRangeDisplay() {
      if (repeatStart !== null && repeatEnd !== null) {
        repeatRangeDisplay.textContent = `リピート区間: ${repeatStart.toFixed(2)} 秒 ～ ${repeatEnd.toFixed(2)} 秒`;
      } else if (repeatStart !== null) {
        repeatRangeDisplay.textContent = `リピート開始: ${repeatStart.toFixed(2)} 秒 ～ (未設定)`;
      } else {
        repeatRangeDisplay.textContent = 'リピート区間: 未設定';
      }
    }

    function updateTimeDisplay() {
      timeDisplay.textContent = `${formatTime(videoPlayer.currentTime)} / ${formatTime(videoPlayer.duration)}`;
    }
    function formatTime(sec) {
      if (!isFinite(sec)) return '00:00';
      const m = Math.floor(sec / 60).toString().padStart(2, '0');
      const s = Math.floor(sec % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }
  </script>
</body>
</html>
